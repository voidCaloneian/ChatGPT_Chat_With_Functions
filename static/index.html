<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <title>–ß–∞—Ç —Å ChatGPT ü§ñ</title>
    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <!-- Google Fonts -->
    <link
      href="https://fonts.googleapis.com/css?family=Roboto&display=swap"
      rel="stylesheet"
    />
    <!-- Marked –¥–ª—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ Markdown -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- Vue.js -->
    <script src="https://cdn.jsdelivr.net/npm/vue@2"></script>
    <style>
      html,
      body {
        height: 100%;
        margin: 0;
      }
      body {
        font-family: 'Roboto', sans-serif;
        background: #f8f9fa;
      }
      /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –∑–∞–Ω–∏–º–∞–µ—Ç 66% —à–∏—Ä–∏–Ω—ã, —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω –∏ —Ä–∞—Å—Ç—è–Ω—É—Ç –ø–æ –≤—ã—Å–æ—Ç–µ */
      #app {
        display: flex;
        flex-direction: column;
        height: 100%;
        width: 66%;
        margin: 0 auto;
        margin-bottom: 20px;
        font-size: 20px;
      }
      h1 {
        font-weight: 700;
        text-align: center;
        margin: 10px 0;
      }
      /* –ß–∞—Ç-–±–ª–æ–∫ –∑–∞–Ω–∏–º–∞–µ—Ç –≤—Å—ë –æ—Å—Ç–∞–≤—à–µ–µ—Å—è –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ */
      #chat-box {
        flex: 1;
        overflow-y: auto;
        border: 1px solid #dee2e6;
        padding: 15px;
        background: #ffffff;
        border-radius: 5px;
        box-shadow: 0 3px 6px rgba(0, 0, 0, 0.1);
        margin: 10px 0;
      }
      .chat-message {
        margin-bottom: 15px;
      }
      .chat-input {
        margin: 10px 0;
      }
    </style>
  </head>
  <body>
    <div id="app">
      <h1>–ß–∞—Ç —Å ChatGPT</h1>
      <div id="chat-box">
        <!-- –°–æ–æ–±—â–µ–Ω–∏—è —á–∞—Ç–∞ -->
        <div v-for="(msg, index) in messages" :key="index" class="chat-message">
          <div v-html="renderMarkdown(msg.sender + ': \n' + msg.text)"></div>
        </div>
      </div>
      <div class="input-group chat-input">
        <input
          type="text"
          class="form-control"
          placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ Markdown"
          v-model="inputMessage"
          @keyup.enter="sendMessage"
        />
        <button class="btn btn-primary" @click="sendMessage">
          –û—Ç–ø—Ä–∞–≤–∏—Ç—å
        </button>
      </div>
    </div>

    <script>
      new Vue({
        el: "#app",
        data: {
          messages: [],
          inputMessage: "",
          ws: null,
          // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–æ–µ —Å–≤–æ–π—Å—Ç–≤–æ –¥–ª—è –∞–∫–∫—É–º—É–ª–∏—Ä–æ–≤–∞–Ω–∏—è –æ—Ç–≤–µ—Ç–∞ –≤ —Ä–µ–∂–∏–º–µ —Å—Ç—Ä–∏–º–∏–Ω–≥–∞
          currentAssistantMessage: null
        },
        methods: {
          renderMarkdown(markdownText) {
            return marked.parse(markdownText);
          },
          sendMessage() {
            const text = this.inputMessage.trim();
            if (text === "") return;
            // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            this.messages.push({ sender: "**–í—ã**", text: text });
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ç–µ–∫—É—â–∏–π –æ—Ç–≤–µ—Ç –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞
            this.currentAssistantMessage = null;
            // –û—Ç–ø—Ä–∞–≤–∫–∞ —á–µ—Ä–µ–∑ WebSocket, –µ—Å–ª–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ
            if (this.ws && this.ws.readyState === WebSocket.OPEN) {
              this.ws.send(text);
            }
            this.inputMessage = "";
          },
          initWebSocket() {
            const protocol = window.location.protocol === "https:" ? "wss" : "ws";
            this.ws = new WebSocket(protocol + "://" + window.location.host + "/api/chat/");
            this.ws.onopen = () => {
              console.log("WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω üòä");
            };
            this.ws.onmessage = (event) => {
              // –í—ã–≤–æ–¥–∏–º –≤ –∫–æ–Ω—Å–æ–ª—å –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
              console.log("–ü–æ–ª—É—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ:", event.data);
            // –ï—Å–ª–∏ –µ—â—ë –Ω–µ –Ω–∞—á–∞–ª–∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞, —Å–æ–∑–¥–∞—ë–º –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
            if (!this.currentAssistantMessage) {
              this.currentAssistantMessage = { sender: "**ChatGPT**", text: "" };
              this.messages.push(this.currentAssistantMessage);
            }
            // –î–æ–ø–∏—Å—ã–≤–∞–µ–º –ø–æ–ª—É—á–µ–Ω–Ω—ã–π —á–∞–Ω–∫ –≤ —Ç–µ–∫—É—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞
            this.currentAssistantMessage.text += event.data;
            // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –∑–∞–ø—É—Å–∫–∞–µ–º –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫—É
            this.$forceUpdate();
            this.$nextTick(() => {
              const chatBox = document.getElementById("chat-box");
              chatBox.scrollTop = chatBox.scrollHeight;
            });
};
            this.ws.onerror = (error) => {
              console.error("–û—à–∏–±–∫–∞ WebSocket:", error);
            };
            this.ws.onclose = () => {
              console.log("WebSocket –∑–∞–∫—Ä—ã—Ç. –ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã... ‚è≥");
              setTimeout(this.initWebSocket, 3000);
            };
          }
        },
        created() {
          this.initWebSocket();
        }
      });
    </script>
  </body>
</html>